{% extends 'base.html' %}

{% block page-container %}

    <div class="chart-container">
        <div class="left-contact-panel">
            contacts
            <div>
              <!-- Nav tabs -->
              <ul class="nav nav-tabs" role="tablist">
                <li role="presentation" class="active">
                    <a href="#contact-tab"  role="tab" data-toggle="tab">好友</a>
                </li>
                <li role="presentation">
                    <a href="#group-tab"  role="tab" data-toggle="tab">群组</a>
                </li>
              </ul>

              <!-- Tab panes -->
               <!-- Tab panes -->
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane active" id="contact-tab">
               <ul class="list-group">
                    {% for friend in request.user.userprofile.friends.select_related %}
                        <li contact-type="single" contact-id="{{ friend.id }}" onclick="OpenChatWindow(this)" class="list-group-item">
                            <span class="badge hide"></span>
                            <span class="contact-name"> {{ friend.name }} </span>
                        </li>
                    {% endfor %}
                </ul>
            </div>

            <div role="tabpanel" class="tab-pane" id="group-tab">
                <ul class="list-group">
                    {% for group in request.user.userprofile.group_members.select_related %}
                        <li contact-type="group" contact-id="{{ group.id }}" onclick="OpenChatWindow(this)" class="list-group-item">
                            <span class="badge hide">0</span>
                            <span class="contact-name"> {{ group.name }} </span>
                        </li>
                    {% endfor %}
                </ul>
            </div>

          </div>
        </div>
    </div>


        <div class="right-chat-panel">
            <div class="chat-box-title" contact-type="" contact-id="">
                title
            </div>
            <div class="chat-box-window">
                window
            </div>
            <div class="chat-box-emoj">
                emoj
            </div>
            <div class="chat-box-msg-box">
                <textarea id="msg"></textarea>
                <button class="btn btn-success">发送消息</button>
            </div>
        </div>
        <div class="clear-both"></div>
    </div>

{% endblock %}



{% block bottom-js %}

<script>
// for jquery csrf
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
var csrftoken = getCookie('csrftoken');

//console.log(csrftoken)

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}

//end csrf

GLOBAL_CHAT_RECORD_DIC = {
    'single':{},
    'group':{},

}

    $(document).ready(function () {
        //set csrf before send ajax
        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        }); // end set csrf

        /*  读取消息
        var MsgRefresher = setInterval(function () {
            getnewmsg();
        }, 3000);
        // end 定时读取消息 */

            getnewmsg();

        $("#navbar a[href='{{ request.path }}']").parent().addClass("active");

        //send msg
        $("body").delegate("textarea","keydown",function (e) {
            if(e.which ==13) {  //Enter key down
                //send msg button clicked
                var msg_text = $("textarea").val();
                if ($.trim(msg_text).length >0){
                    console.log(msg_text)
                    SenMsg(msg_text)
                }
                // no wait the sen_msg's call confirm msg
                AddSentMsgIntoBox(msg_text)
                $("textarea").val('');

            }
        });

    });//end doc ready

    function SenMsg (msg_text) {
        var contact_type = $(".chat-box-title").attr("contact-type");
        var contact_id = $(".chat-box-title").attr("contact-id");
        if (contact_type && contact_id) {
            var msg_item = {
                "from": "{{ request.user.userprofile.id }}",
                "to": contact_id,
                "type":contact_type,
                "msg":msg_text
            };

            $.post("{% url 'send_msg' %}",{data:JSON.stringify(msg_item)},function (callback) {
                console.log(callback)
            })  // end post
        } //end if
    }



    function AddSentMsgIntoBox(msg_text) {
        var new_msg_ele = "<div class='msg-itme'>" +
                                "<span>" + "{{ request.user.userprofile.name }}" + "</span>" +
                                "<span>" + new Date().toLocaleDateString() + "</span>" +
                                "<div class='msg-text'>" + msg_text + "</div>" +
                            "</div>"
        $(".chat-box-window").append(new_msg_ele)

        $(".chat-box-window").animate({
            scrollTop: $(".chat-box-window") [0].scrollHeight},500)
    }



    function OpenChatWindow(ele){
        console.log($(ele));

        $(ele).addClass("active");
        $(ele).siblings().removeClass("active");
        var contact_id = $(ele).attr("contact-id");
        var contact_name = $(ele).find(".contact-name").text();
        var contact_type = $(ele).attr("contact-type");

        // 在切换之前吧当前的聊天记录归档
        var current_session_id = $(".chat-box-title").attr("contact-id");
        var current_session_type = $(".chat-box-title").attr("contact-type");
        if (current_session_id){    //has session
            // do switch
            GLOBAL_CHAT_RECORD_DIC[current_session_type][current_session_id] = $('.chat-box-window').html()
        }

        var chat_box_title_content =  contact_name;
        $(".chat-box-title").html(chat_box_title_content);
        $(".chat-box-title").attr("contact-type",contact_type);
        $(".chat-box-title").attr("contact-id",contact_id);


        var new_contact_char_record = GLOBAL_CHAT_RECORD_DIC[contact_type][contact_id];
        if (typeof new_contact_char_record == 'undefined'){
            new_contact_char_record = '';

         }
         $('.chat-box-window').html(new_contact_char_record);

         //hide new msg notifier badge
        var contact_ele = $(".list-group li[contact-type='"+ contact_type +"']").filter("li[contact-id='"+ contact_id +"']")[0];
        $(contact_ele).find(".badge").text(0);
        $(contact_ele).find(".badge").addClass("hide");
    }

    function  getnewmsg() {
        $.getJSON("{% url 'get_new_msgs' %}", function (callback) {
            console.log(callback);
            ParseNewMsg(callback);  // 把新消息进行解析
            getnewmsg()
        });
    }

    function ParseNewMsg(callback) {
        var current_session_type = $(".chat-box-title").attr("contact-type");
        var current_session_id = $(".chat-box-title").attr("contact-id");

        for( var i in callback) {
            console.log(callback[i]);
            if(callback[i].type == 'single'){
                var msg_from_contact_id = callback[i]['from'];
            }else{
                var msg_from_contact_id =callback[i]['to'];
            }

            // { type: "single", from: "1", msg: "hello word", to: "3", timestamp: 1561366027.470069 }
             var msg_itme_ele = "<div class='msg-itme'>" +
                                         "<span>" + callback[i].from + "</span>" +
                                         "<span>" + callback[i].timestamp + "</span>" +
                                         "<div class='msg-text'>" + callback[i].msg + "</div>" +
                                    "</div>";

            if ( msg_from_contact_id == current_session_id && current_session_type == callback[i].type){
                // 此消息烦的发送方当前正在再跟我聊天

                $(".chat-box-window").append(msg_itme_ele)
            }else {
                //此消息发送者是自己 当前没有打开聊天框 消息暂存内存
                if(GLOBAL_CHAT_RECORD_DIC[callback[i].type][current_session_id]){
                    GLOBAL_CHAT_RECORD_DIC[current_session_type][current_session_id] += msg_itme_ele
                }else {
                    GLOBAL_CHAT_RECORD_DIC[callback[i].type][callback[i].from] = msg_itme_ele
                }   //end if

                //新消息提醒
                var contact_ele = $(".list-group li[contact-type='"+ callback[i].type +"']").filter("li[contact-id='"+ callback[i].from +"']")[0];
                var current_new_msg_num = $(contact_ele).find(".badge").text();
                $(contact_ele).find(".badge").removeClass("hide");
                $(contact_ele).find(".badge").text(parseInt(current_new_msg_num)+1);

            }

        }
    }



</script>

{% endblock %}